```markdown
# Шифр "Магма" (ГОСТ Р 34.12-2015)

Данный проект реализует алгоритм симметричного шифрования «Магма», утверждённый стандартом ГОСТ Р 34.12-2015. Программа позволяет шифровать и дешифровать данные в режимах ECB и CBC с использованием 256-битного ключа.

---

## Теоретическое описание алгоритма

Алгоритм «Магма» относится к блочным симметричным шифрам и имеет следующие особенности:

- **Длина шифруемого блока:** 64 бита.  
  Перед шифрованием 64-битный блок делится на две равные части по 32 бита – левую (A0) и правую (A1).

- **Длина ключа:** 256 бит.  
  Исходный ключ разбивается на 8 подклучей по 32 бита.

- **Раунды шифрования:** 32 итерации (раунда).  
  Для каждого раунда используется раундовый ключ, который определяется следующим образом:
  - Первые 24 раунда используют 8 подклучей, повторённых три раза.
  - Последние 8 раундов используют 8 подклучей в обратном порядке.

- **Структура раунда:**  
  Каждый раунд (за исключением тридцать второй, где обмен местами не производится) строится по принципу сети Фейстеля и включает следующие шаги:
  
  1. **Сложение по модулю 2^32:** Правая часть (32 бита) складывается с текущим раундовым ключом.
  2. **Нелинейное преобразование (S-box):** Полученное 32-битное число делится на 8 4-битных блоков (нибблов). Для каждого ниббла применяется соответствующая таблица подстановок, которая заменяет исходное 4-битное значение на другое.
  3. **Циклический сдвиг:** Результат нелинейного преобразования циклически сдвигается влево на 11 разрядов. При этом выбывающие биты «окружаются» и попадают в правую часть числа.
  4. **Операция XOR:** Полученное значение ксорится с левой частью блока.
  5. **Перестановка:** Результат (новое значение правой части) записывается, а текущая правая часть переходит на место левой. В последнем раунде обмен местами не выполняется – объединяются итоговая левая и правая части.

- **Режимы работы:**  
  Программа поддерживает режим ECB (Electronic Codebook), в котором каждый 64-битный блок обрабатывается независимо, и режим CBC (Cipher Block Chaining), где предыдущий зашифрованный блок используется для обработки следующего блока посредством операции XOR.

- **PKCS#7 Padding:**  
  Для работы с данными произвольной длины применяется схема дополнения PKCS#7, которая гарантирует, что длина данных будет кратна 8 байтам (64 бита).

---

## Описание работы программы

Программа реализована на Python и содержит два основных режима работы:

1. **Интерактивный режим (interactive_mode):**  
   Если программа запущена без аргументов командной строки, пользователю последовательно предлагается ввести:
   - Операцию: шифрование или расшифрование.
   - 256-битный ключ в шестнадцатеричном формате (64 символа).
   - Режим работы: ECB или CBC.  
     При выборе CBC пользователю может быть предложено ввести вектор инициализации (IV) или сгенерировать случайный IV.
   - Источник данных: текстовая строка или файл.
   - Режим вывода: результат выводится на консоль или сохраняется в файл.

2. **Режим работы через аргументы командной строки (arguments_mode):**  
   С помощью параметров командной строки можно задать:
   - **Операция:** `-e/--encrypt` для шифрования или `-d/--decrypt` для расшифрования.
   - **Ключ:** параметр `-k/--key` — 256-битный ключ в формате hex (64 символа).
   - **Режим шифрования:** `-m/--mode` с выбором между `ecb` и `cbc`.
   - **Вектор инициализации (для CBC):** `-v/--iv` (16 hex-символов).
   - **Источник данных:** `-t/--text` для текста или `-i/--input` для указания файла с данными.
   - **Вывод результата:** `-o/--output` — путь к выходному файлу (если не указан, результат выводится в консоль).

### Структура кода

- **Классы `Magma` и `MagmaCBC`:**  
  - Реализуют базовые операции алгоритма «Магма»: подготовку раундовых ключей, работу S-box, циклический сдвиг, разделение блока, а также функции для шифрования и дешифрования 64-битных блоков.
  - В классе `MagmaCBC` дополнительно реализована логика работы в режиме CBC (операция XOR с предыдущим блоком, использование вектора инициализации).

- **Функции `interactive_mode()` и `arguments_mode()`:**  
  - Обеспечивают два способа запуска программы.
  - В интерактивном режиме пользователь вводит данные через консоль.
  - В режиме с аргументами командной строки используются параметры, передаваемые при запуске скрипта.

- **Модуль `PKCS7Padding`:**  
  - Используется для дополнения данных по схеме PKCS#7, чтобы длина данных была кратна 8 байтам.

- **Функция `main()`:**  
  - Определяет, какой режим запуска использовать (интерактивный, если аргументы отсутствуют, или аргументированный).

---

## Варианты запуска программы

Программа поддерживает два основных режима запуска:

### 1. Интерактивный режим

Запуск без параметров:
```bash
python your_script.py
```
В этом режиме программа:
- Запросит выбор операции (шифрование/расшифрование).
- Попросит ввести 256-битный ключ в формате hex (64 символа).
- Предложит выбрать режим шифрования (ECB или CBC).  
  При выборе CBC можно ввести вектор инициализации (16 hex-символов) или выбрать автоматическую генерацию случайного IV.
- Запросит источник данных: текст для обработки или путь к файлу.
- Предложит выбор вывода результата: консоль или файл.
- После обработки результат будет выведен согласно выбору пользователя.

### 2. Запуск через терминал с параметрами

Запуск программы с использованием аргументов командной строки:
```bash
python your_script.py -e -k <ключ> -m <режим> -t <текст> [-v <IV>] [-o <выходной_файл>]
```
**Описание параметров:**

- `-e` или `--encrypt`  
  Указывает на операцию шифрования. Для расшифрования используется `-d` или `--decrypt`.

- `-k <ключ>`, `--key <ключ>`  
  Обязательный параметр. Передаётся 256-битный ключ в формате hex (64 символа).  
  Пример:  
  ```
  -k ffeeddccbbaa99887766554433221100f0f1f2f3f4f5f6f7f8f9fafbfcfdfeff
  ```

- `-m <режим>`, `--mode <режим>`  
  Режим шифрования: `ecb` или `cbc`. По умолчанию используется `ecb`.  
  Пример:  
  ```
  -m cbc
  ```

- `-v <IV>`, `--iv <IV>`  
  Вектор инициализации для режима CBC. Должен быть длиной 16 hex-символов (8 байт).  
  Пример:  
  ```
  -v 0123456789abcdef
  ```

- `-t <текст>`, `--text <текст>`  
  Текст для обработки. Если производится шифрование, текст берётся как строка, если расшифрование — ожидается hex-строка.  
  Пример:  
  ```
  -t "Шифрование/расшифрование на основе шифра Магма (ГОСТ Р 34.12-2015)"
  ```

- `-i <файл>`, `--input <файл>`  
  Альтернативный способ указания источника данных – путь к входному файлу.

- `-o <файл>`, `--output <файл>`  
  Путь для сохранения результата в файл. Если не указан, результат выводится в консоль.

---

## Примеры вариантов запуска

### Пример 1. Запуск в интерактивном режиме

Запустите скрипт без аргументов:
```bash
python your_script.py
```
Пример диалога в консоли:
```
*** Шифрование/расшифрование на основе шифра "Магма" (ГОСТ Р 34.12-2015) ***
Выберите операцию шифрования (зашифровать - [encrypt], расшифровать - [decrypt]): encrypt
Введите 256-битный ключ (64 hex-символа): ffeeddccbbaa99887766554433221100f0f1f2f3f4f5f6f7f8f9fafbfcfdfeff
Выберите режим работы (ECB/CBC): ECB
Выберите источник данных (текст - [text], файл - [file]): text
Введите текст: Шифрование/расшифрование на основе шифра Магма (ГОСТ Р 34.12-2015)
Куда вывести результат (консоль - [console], файл - [file]): console

Зашифрованный текст:
<вывод зашифрованного результата в hex или текстовом виде>
```

### Пример 2. Запуск через терминал с аргументами (ECB режим)

```bash
python your_script.py -e -k ffeeddccbbaa99887766554433221100f0f1f2f3f4f5f6f7f8f9fafbfcfdfeff -m ecb -t "Шифрование/расшифрование на основе шифра Магма (ГОСТ Р 34.12-2015)"
```
Программа выполнит операцию шифрования в режиме ECB и выведет результат в консоль.

### Пример 3. Запуск через терминал с аргументами (CBC режим)

```bash
python your_script.py -e -k ffeeddccbbaa99887766554433221100f0f1f2f3f4f5f6f7f8f9fafbfcfdfeff -m cbc -v 0123456789abcdef -t "Шифрование/расшифрование на основе шифра Магма (ГОСТ Р 34.12-2015)" -o encrypted.bin
```
В данном примере:
- Шифруется текст с использованием режима CBC.
- Вектор инициализации задан явно как `0123456789abcdef`.
- Результат шифрования сохраняется в файл `encrypted.bin`.

---

## Тестовые данные

Для проверки работы программы можно использовать следующие тестовые данные:

- **Ключ (256 бит, hex):**  
  `ffeeddccbbaa99887766554433221100f0f1f2f3f4f5f6f7f8f9fafbfcfdfeff`

- **Открытый текст:**  
  `Шифрование/расшифрование на основе шифра Магма (ГОСТ Р 34.12-2015)`

При корректной работе алгоритма результат шифрования будет соответствовать спецификации и, в зависимости от выбранного режима, даст однозначное зашифрованное представление данных.

---

Данный README.md документ описывает теоретические основы работы алгоритма «Магма», принцип работы программы, варианты запуска и примеры использования. Надеемся, что предоставленная информация будет полезна для понимания и использования данного программного обеспечения.
```